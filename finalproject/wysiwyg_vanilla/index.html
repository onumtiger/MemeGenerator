<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        @font-face {
            font-family: Impact;
            src: url(impact.ttf) format("truetype");
        }
        #force-font-preload { /* the <span> this applies to is empty, but specifying the font forces it to be downloaded immediately, effectively delaying the window.load event and thereby avoiding bugs stemming from the font being loaded after canvas already started processing text */
            font-family: Impact;
        }
        #page-wrapper, .in-caption-formatting-table {
            width: 100%;
            border: 0;
            padding: 0;
            margin: 0;
            border-collapse: collapse;
        }
        #page-left, #page-right {
            width: 50%;
            box-sizing: border-box;
            padding: 10px 20px;
            vertical-align: top;
        }
        #page-left {
            border-right: 1px solid gray;
            text-align: center;
        }
        #in-title {
            background-color: transparent;
            width: 100%;
            font-size: 25px;
            border: none;
            border-bottom: 1px solid lightgray;
            text-align: center;
            margin-bottom: 20px;
        }
        #in-captions-list {
            padding: 0;
        }
        #in-captions-list li {
            list-style-type: none;
            margin-bottom: 10px;
        }
        #in-captions-list summary {
            /* old:
            padding: 10px;
            new:
            */
            padding: 11px;
            position: relative;
        }
        
        .in-caption {
            border: 0;
            background-color: transparent;
            font-size: inherit;
            /* old:
            width: 90%;
            new: */
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            padding: 10px 30px;
        }

        .in-caption-delete {
            background-color: transparent;
            border: none;
            color: darkred;
            cursor: pointer;
            transition: color .3s;
            /* old:
            float: right;
            new: */
            position: absolute;
            top: 0;
            right: 0;
            padding: 8px;
            padding-right: 15px;
            height: 100%;
            box-sizing: border-box;
        }
        .in-caption-delete:hover {
            color: red;
        }

        #in-captions-list details {
            border: 1px solid lightgray;
            background-color: #95b9d6;
            transition-property: background-color;
            transition-duration: .8s;
        }
        #in-captions-list summary:hover {
            background-color: #d9e5ee;
            transition: background-color .3s;
        }
        .in-caption-formatting-wrapper {
            padding-left: 33px;
        }
        .in-caption-formatting-table th, .in-caption-formatting-table td {
            vertical-align: top;
            padding-bottom: 30px;
        }
        .in-caption-formatting-table input[type="range"] {
            vertical-align: bottom;
            margin: 0;
            margin-left: 5px;
        }
        .in-caption-formatting-table label {
            display: block;
        }
        #canvas-editor {
            cursor: text;
        }
        
        #download-btn {
            background-color: #6079d7;
            color: #fff;
            letter-spacing: .0625rem;
            box-shadow: 0 3px 5px 1px rgb(163, 166, 168);
            padding: 8px;
            border: 1px solid #2c6799;
            border-radius: 3px;
            font-size: 12pt;
            width: 100%;
            box-sizing: border-box;
            margin: 20px 0;
            cursor: pointer;
        }
    </style>
    <script>
        let cElem, c; //canvas element, canvas drawing object
        let image; //background image (meme template)
        let textBoxes = []; //array containing all captions, each as an instance of class TextBox
        let activeTextBoxes = ()=>textBoxes.filter((e)=>!e.disabled); //get all non-disabled entries of textBoxes
        let selectedTextBoxIndex = -1; //index within textBoxes for the textbox that is currently selected
        let draggingTextBox = false; //indicates wether the selected textBox is currently being dragged
        let hoveringTextBoxIndex = -1; //index within textBoxes for the textbox that is currently being hovered over
        let textBoxPadding = 8; //buffer (in pixels) between textbox border and actual font

        class TextBox {
            constructor(x, y, t, fs, c, b=false, ff="Impact"){
                this.startX = x; //top-left x
                this.startY = y; //top-left y
                this.text = t; //caption string
                this.fontSize = fs; //font size (px)
                this.color = c; //text fill color
                this.bold = b; //boolean for bold text
                this.fontFamily = ff; //font family

                this.dragOffsetX = 0; //distance between the mousedown x coord and startX for anchored drag & drop
                this.dragOffsetY = 0; //distance between the mousedown y coord and startY for anchored drag & drop
                this.calcDimensions();
                this.disabled = false; //disabled (removed) boxes will be ignored for interaction and rendering
                this.controller = null; //the wrapper HTMLDetailsElement (caption box) for the controlling inputs, can be set later via setController()
            }
            contains(cx, cy){
                return (cx >= this.startX-textBoxPadding && cx <= this.startX+this.width+textBoxPadding
                     && cy >= this.startY-textBoxPadding && cy <= this.startY+this.height+textBoxPadding);
            }
            calcDimensions(){
                //estimate text width given the font params
                c.font = `${this.bold ? "bold" : "normal"} ${this.fontSize}px ${this.fontFamily}`;
                let textMeasurement = c.measureText(this.text);
                
                //apply estimate width / height
                this.width = textMeasurement.width;
                this.height = this.fontSize*0.9; //determined via testing: this is pretty accurate to give the line height
            }
            disable(){
                this.disabled = true;
            }
            setController(el){
                this.controller = el;
            }
            updateText(text){
                this.text = text;
                this.calcDimensions();
            }
            updateFontSize(fs){
                this.fontSize = fs;
                this.calcDimensions();
            }
            updateColor(c){
                this.color = c;
            }
            updateBold(b){
                this.bold = b;
                this.calcDimensions();
            }
            updateFontFamily(ff){
                this.fontFamily = ff;
                this.calcDimensions();
            }
            setDragAnchor(mx, my){
                this.dragOffsetX = mx - this.startX;
                this.dragOffsetY = my - this.startY;
            }
            moveTo(mx, my){
                this.startX = mx - this.dragOffsetX;
                this.startY = my - this.dragOffsetY;
            }
        }

        function init(){
            cElem = document.getElementById('canvas-editor');
            c = cElem.getContext('2d');
            
            //debug: add textboxes in Impact to test the (cache-free) font loading
            // textBoxes.push(new TextBox(10, 10, "Holiday", 50, "white"));
            // textBoxes.push(new TextBox(200, 10, "OMM", 50, "white"));
            //---

            setBgImage("testmeme.png"); //will also trigger (re)paint

            cElem.addEventListener('mousedown', onMouseDown);
            cElem.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUpDocument);
            cElem.addEventListener('mouseup', onMouseUpCanvas);
            document.getElementById('page-right').addEventListener('click',(e)=>{
                //if we click on the blank space around the caption boxes on the right side of the page, de-select it and the corresponding textbox in the canvas
                deselectAllCaptions();
            }, false);
            document.getElementById('download-btn').addEventListener('click',(e)=>{
                // remove all caption outlines
                deselectAllCaptions();
                //download the current canvas image
                let url = cElem.toDataURL('image/png');
                document.getElementById('download-anchor').href = url;
                //we don't have to do the deselection again, so let's prevent the event from bubbling up to #page-right
                e.stopPropagation();
            });
        }

        function deselectAllCaptions(){
            selectedTextBoxIndex = -1;
            repaint();
            hideAllCaptionBoxesExcept(null);
        }

        function setBgImage(src){
            if(src.length){
                image = new Image();
                image.src = src;

                image.addEventListener('load', ()=>{
                    //the image should be of the same size as the canvas, but the canvas width can't be predetermined in HTML due to only absolute pixel values being allowed in the width attribute (which we have to use as CSS styling messes with stuff like mouse coords)
                    //so, let's determine the maximum available width for the canvas (50% of the viewport width minus padding & border)
                    let actualStyles = window.getComputedStyle(document.querySelector('#page-left'));
                    let actualWidth = parseInt(actualStyles.getPropertyValue('width'));
                    let actualPaddingLeft = parseInt(actualStyles.getPropertyValue('padding-left'));
                    let actualPaddingRight = parseInt(actualStyles.getPropertyValue('padding-right'));
                    let borderWidth = 1;
                    let innerWidth = actualWidth-actualPaddingLeft-actualPaddingRight-borderWidth;
                    //determine the height that correctly scales the image based on the calculated width
                    let scaledImageHeight = parseInt(innerWidth * image.height / image.width);
                    //apply these values
                    [cElem.width, cElem.height] = [innerWidth, scaledImageHeight];
                    repaint();
                });
            }else{
                c.clearRect(0, 0, cElem.width, cElem.height);
            }
        }

        function repaint(){
            //clear the canvas
            c.clearRect(0, 0, cElem.width, cElem.height);
            //draw the image background
            drawImage();
            //draw the text foreground
            drawText();
            //draw selection and hovering textbox outlines where necessary
            if(selectedTextBoxIndex > -1) drawTextBoxOutline(textBoxes[selectedTextBoxIndex], "black");
            if(hoveringTextBoxIndex > -1 && (selectedTextBoxIndex != hoveringTextBoxIndex)) drawTextBoxOutline(textBoxes[hoveringTextBoxIndex], "gray");
        }

        function drawImage(){
            c.drawImage(image,0,0, cElem.width, cElem.height);
        }
        
        function drawText(){
            activeTextBoxes().forEach((e) => {
                let text = e.text;

                c.font = `${e.bold ? "bold" : "normal"} ${e.fontSize}px ${e.fontFamily}`;
                c.fillStyle = e.color;
                c.strokeStyle = "black";
                c.shadowColor = "black";
                c.shadowBlur = 5;
                c.textBaseline = "top";
                c.lineWidth = 4;


                c.strokeText(text,e.startX,e.startY); //draw the font outline with shadow
                c.shadowBlur = 0;
                c.fillText(text,e.startX,e.startY); //draw the filled font without shadow
            })
        }

        function drawTextBoxOutline(tb, color){
            c.lineWidth = 1;
            c.strokeStyle = color;
            c.beginPath();
            c.moveTo(tb.startX - textBoxPadding,
                    tb.startY - textBoxPadding);
            c.lineTo(tb.startX + textBoxPadding + tb.width,
                    tb.startY - textBoxPadding);
            c.lineTo(tb.startX + textBoxPadding + tb.width,
                    tb.startY + textBoxPadding + tb.height)
            c.lineTo(tb.startX - textBoxPadding,
                    tb.startY + textBoxPadding + tb.height);
            c.closePath();
            c.stroke();
        }

        function checkForHoverChange(mouseX, mouseY){
            let hov = textBoxes.findIndex((o)=>{
                return (!o.disabled && o.contains(mouseX, mouseY));
            });
            let ret = (hov!=hoveringTextBoxIndex);
            hoveringTextBoxIndex = hov;
            return ret;
        }

        function onMouseDown(e){
            if(e.button!=0) return; //only watch for the left mouse button
            
            let sel = selectedTextBoxIndex;
            selectedTextBoxIndex = textBoxes.findIndex((o)=>{ //check if the mousedown is on any of our textboxes
                return (!o.disabled && o.contains(e.offsetX, e.offsetY));
            });
            if(selectedTextBoxIndex != sel) repaint();
            if(selectedTextBoxIndex > -1){ //if so, enter dragging mode
                draggingTextBox = true;
                //set the dragOffset / move anchor
                textBoxes[selectedTextBoxIndex].setDragAnchor(e.offsetX, e.offsetY);
                //indicate that we are grabbing this textbox via cursor
                setCanvasCursor('grabbing');
                //show the corresponding caption box
                hideAllCaptionBoxesExcept(textBoxes[selectedTextBoxIndex].controller);
                showCaptionBox(textBoxes[selectedTextBoxIndex].controller);
            }
        }

        function onMouseMove(e){
            //first, check if we are currently moving a textbox
            if(draggingTextBox){ //if so, just apply the current mouse coords to the box position
                textBoxes[selectedTextBoxIndex].moveTo(e.offsetX, e.offsetY);
                repaint();
            }else{ //if not, check if we are hovering over any of our textboxes
                let oldHov = hoveringTextBoxIndex;
                if(checkForHoverChange(e.offsetX, e.offsetY)) { //make sure this is a new hover to prevent unnecessarily redoing the same thing
                    if(hoveringTextBoxIndex > -1){ //if we are hovering over a textbox we haven't been hovering over just before...
                        //highlight that textbox via outline
                        //we can get away without a full repaint if nothing else was hovered over before
                        if(oldHov > -1) repaint();
                        else if(hoveringTextBoxIndex != selectedTextBoxIndex) drawTextBoxOutline(textBoxes[hoveringTextBoxIndex], "gray");
                        // indicate that we're ready to grab via cursor
                        setCanvasCursor('grab');
                    }else{ //if we are not hovering over a textbox but have before, remove the highlighting and reset the cursor
                        repaint();
                        setCanvasCursor('text');
                    }
                }
            }
        }

        function onMouseUpDocument(e){
            if(e.button!=0) return; //only watch for the left mouse button
            
            //if we are / were dragging a textbox around...
            if(draggingTextBox) {
                //exit dragging mode
                draggingTextBox = false;
                //reset selection & hover
                //selectedTextBoxIndex = -1;
                checkForHoverChange(e.offsetX, e.offsetY);
                //reset cursor accordingly
                setCanvasCursor((hoveringTextBoxIndex > -1) ? 'grab' : 'text');
                //full repaint is inevitable, with the updated selection alone
                repaint();
            }
        }

        function onMouseUpCanvas(e){
            if(e.button!=0) return; //only watch for the left mouse button
            
            if(!draggingTextBox){
                addCaptionAt(e.offsetX, e.offsetY);
            } //else case will be handled once the event bubbles up to the document via onMouseUpDocument()
        }

        function addCaptionAt(mx, my){
            let newIndex = textBoxes.length;
            let newTextBox = new TextBox(parseInt(mx), parseInt(my), " ", 60, "white");
            textBoxes.push(newTextBox);
            let li = document.createElement('li');
            li.innerHTML = `
                                <details>
                                    <summary>
                                        <input class="in-caption" type="text" placeholder="Please enter a caption...">
                                        <button type="button" class="in-caption-delete" title="Remove this caption">&#10006;</button>
                                    </summary>
                                    <div class="in-caption-formatting-wrapper">
                                        <table class="in-caption-formatting-table">
                                            <tbody>
                                                <tr>
                                                    <th>Font Size:</th>
                                                    <td>
                                                        <label>
                                                            <input type="range" name="fontSize" min="10" max="200" value="60" step="1">
                                                            <span class="label-fontSize">60px</span>
                                                        </label>
                                                        <label>
                                                            <input type="checkbox" name="bold">
                                                            bold
                                                        </label>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Font Color:</th>
                                                    <td>
                                                        <label>
                                                            <abbr title="Red color value (0-255)">R</abbr>:
                                                            <input type="range" name="colorR" min="0" max="255" value="255" step="1">
                                                            <span class="label-colorR">255</span>
                                                        </label>
                                                        <label>
                                                            <abbr title="Green color value (0-255)">G</abbr>:
                                                            <input type="range" name="colorG" min="0" max="255" value="255" step="1">
                                                            <span class="label-colorG">255</span>
                                                        </label>
                                                        <label>
                                                            <abbr title="Blue color value (0-255)">B</abbr>:
                                                            <input type="range" name="colorB" min="0" max="255" value="255" step="1">
                                                            <span class="label-colorB">255</span>
                                                        </label>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Font Face:</th>
                                                    <td>
                                                        <select name="fontFace">
                                                            <option value="Impact" selected>Impact</option>
                                                            <option value="Arial">Arial</option>
                                                            <option value="Verdana">Verdana</option>
                                                            <option value="Helvetica">Helvetica</option>
                                                            <option value="Tahoma">Tahoma</option>
                                                            <option value="Trebuchet MS">Trebuchet MS</option>
                                                            <option value="Times New Roman">Times New Roman</option>
                                                            <option value="Georgia">Georgia</option>
                                                            <option value="Garamond">Garamond</option>
                                                            <option value="Courier New">Courier New</option>
                                                            <option value="Brush Script MT">Brush Script MT</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </details>
            `;
            document.getElementById('in-captions-list').appendChild(li);
            let captionInput = li.querySelector('.in-caption');
            let captionDetails = li.querySelector('details');
            let captionRemove = li.querySelector('.in-caption-delete');
            let fontSizeInput = li.querySelector('input[name=fontSize]');
            let fontSizeLabel = li.querySelector('.label-fontSize');
            let boldInput = li.querySelector('input[name=bold]');
            let colorRInput = li.querySelector('input[name=colorR]');
            let colorRLabel = li.querySelector('.label-colorR');
            let colorGInput = li.querySelector('input[name=colorG]');
            let colorGLabel = li.querySelector('.label-colorG');
            let colorBInput = li.querySelector('input[name=colorB]');
            let colorBLabel = li.querySelector('.label-colorB');
            let fontFaceInput = li.querySelector('select[name=fontFace]');
            newTextBox.setController(captionDetails);
            li.addEventListener('focus', (e2)=>{
                if(e2.target != captionRemove){
                    if(!captionDetails.open) showCaptionBox(captionDetails);
                    hideAllCaptionBoxesExcept(captionDetails);
                    selectedTextBoxIndex = newIndex;
                    repaint();
                }
            }, true);
            li.addEventListener('click', (e2)=>{
                if(e2.target != captionRemove){
                    //stop the de-selection onclick EventListener from reaching the caption <li>s
                    e2.stopPropagation();
                }
            }, true);
            captionInput.focus();
            captionInput.select();
            captionDetails.style.backgroundColor = '#d9e5ee';
            captionDetails.style.transitionDuration = '.3s';

            hideAllCaptionBoxesExcept(captionDetails);
            captionRemove.addEventListener('click', (e2)=>{
                // e2.stopPropagation();
                newTextBox.disable();
                selectedTextBoxIndex = -1;
                repaint();
                li.style.display = 'none';
            });
            captionInput.addEventListener('input', (e2)=>{
                newTextBox.updateText(e2.target.value);
                repaint();
            });
            fontSizeInput.addEventListener('input', (e2)=>{
                newTextBox.updateFontSize(parseInt(e2.target.value));
                repaint();
                fontSizeLabel.textContent = e2.target.value+'px';
            });
            boldInput.addEventListener('change', (e2)=>{
                newTextBox.updateBold(e2.target.checked);
                repaint();
            });
            colorRInput.addEventListener('input', (e2)=>{
                newTextBox.updateColor(`rgb(${e2.target.value},${colorGInput.value},${colorBInput.value})`);
                repaint();
                colorRLabel.textContent = e2.target.value;
            });
            colorGInput.addEventListener('input', (e2)=>{
                newTextBox.updateColor(`rgb(${colorRInput.value},${e2.target.value},${colorBInput.value})`);
                repaint();
                colorGLabel.textContent = e2.target.value;
            });
            colorBInput.addEventListener('input', (e2)=>{
                newTextBox.updateColor(`rgb(${colorRInput.value},${colorGInput.value},${e2.target.value})`);
                repaint();
                colorBLabel.textContent = e2.target.value;
            });
            fontFaceInput.addEventListener('change', (e2)=>{
                newTextBox.updateFontFamily(e2.target.value);
                repaint();
            });
        }

        function hideAllCaptionBoxesExcept(element){
            document.querySelectorAll('#in-captions-list details').forEach((el)=>{
                if(el!=element){
                    el.style.backgroundColor = "transparent";
                    el.open = false;
                }
            });
        }

        function showCaptionBox(element){
            element.open = true;
            element.style.backgroundColor = "#d9e5ee";
        }

        function setCanvasCursor(cursor){
            cElem.style.cursor = cursor;
        }

        window.onload = init;
    </script>
</head>
<body>
    <table id="page-wrapper">
        <tbody>
            <tr>
                <td id="page-left">
                    <!-- <h2 id="title">&nbsp;</h2> --><!-- the non-breaking space already reserves space in the layout without being visible text -->
                    <input id="in-title" type="text" placeholder="Enter a title for your meme post...">
                    <canvas id="canvas-editor" width="600" height="800">Your browser does not support the Canvas Element. Please switch to a more current browser.</canvas>
                </td>
                <td id="page-right">
                    <form>
                        <h2>Add some Captions to your Meme</h2>
                        <p>Click somewhere in the image to add a caption at that point.<span id="force-font-preload"></span></p>
                        <ul id="in-captions-list">
                            <!-- 
                            <li>
                                <details>
                                    <summary>
                                        <input class="in-caption" type="text" placeholder="Please enter a caption...">
                                        <button type="button" class="in-caption-delete" title="Remove this caption">&#10006;</button>
                                    </summary>
                                    <div class="in-caption-formatting-wrapper">
                                        <table class="in-caption-formatting-table">
                                            <tbody>
                                                <tr>
                                                    <th>Font Size:</th>
                                                    <td>
                                                        <label>
                                                            <input type="range" name="fontSize" min="10" max="200" value="60" step="1">
                                                            <span class="label-fontSize">60px</span>
                                                        </label>
                                                        <label>
                                                            <input type="checkbox" name="bold">
                                                            bold
                                                        </label>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Font Color:</th>
                                                    <td>
                                                        <label>
                                                            <abbr title="Red color value (0-255)">R</abbr>:
                                                            <input type="range" name="colorR" min="0" max="255" value="255" step="1">
                                                            <span class="label-colorR">255</span>
                                                        </label>
                                                        <label>
                                                            <abbr title="Green color value (0-255)">G</abbr>:
                                                            <input type="range" name="colorG" min="0" max="255" value="255" step="1">
                                                            <span class="label-colorG">255</span>
                                                        </label>
                                                        <label>
                                                            <abbr title="Blue color value (0-255)">B</abbr>:
                                                            <input type="range" name="colorB" min="0" max="255" value="255" step="1">
                                                            <span class="label-colorB">255</span>
                                                        </label>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Font Face:</th>
                                                    <td>
                                                        <select name="fontFace">
                                                            <option value="Impact" selected>Impact</option>
                                                            <option value="Arial">Arial</option>
                                                            <option value="Verdana">Verdana</option>
                                                            <option value="Helvetica">Helvetica</option>
                                                            <option value="Tahoma">Tahoma</option>
                                                            <option value="Trebuchet MS">Trebuchet MS</option>
                                                            <option value="Times New Roman">Times New Roman</option>
                                                            <option value="Georgia">Georgia</option>
                                                            <option value="Garamond">Garamond</option>
                                                            <option value="Courier New">Courier New</option>
                                                            <option value="Brush Script MT">Brush Script MT</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </details>
                            </li>
                            -->
                        </ul>
                        <a id="download-anchor" download="Your Meme.png">
                            <button type="button" id="download-btn">Download image</button>
                          </a>
                    </form>
                </td>
            </tr>
        </tbody>
    </table>
</body>
</html>